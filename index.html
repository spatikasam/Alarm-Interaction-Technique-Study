<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>Scroll vs Radial Clock-Wheel – Alarm Study</title>
<style>
  :root { --blue:#007aff; --red:#ff3b30; --green:#34c759; }
  * { box-sizing:border-box; margin:0; padding:0; }
  body {
    font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text",system-ui,sans-serif;
    background:#000;
    display:flex;
    justify-content:center;
    align-items:center;
    min-height:100vh;
    overflow-x:hidden;
  }
  
  .phone {
    width:390px;
    max-width:100vw;
    height:844px;
    max-height:100vh;
    background:#1c1c1e;
    overflow-y:auto;
    overflow-x:hidden;
    color:#f5f5f5;
    position:relative;
  }

  .container { 
    padding:20px;
    width:100%;
  }

  h1 { 
    text-align:center; 
    font-size:28px; 
    font-weight:700; 
    margin:20px 0 8px;
    color:#fff;
  }
  
  h1 small {
    display:block;
    font-weight:400;
    font-size:14px;
    color:#8e8e93;
    margin-top:4px;
  }
  
  .config, #trial-table-container, #results-container {
    background:#2c2c2e; 
    border-radius:16px; 
    padding:16px; 
    margin:16px 0;
  }
  
  label {
    display:block;
    font-size:12px;
    font-weight:600;
    color:#8e8e93;
    margin-bottom:6px;
    text-transform:uppercase;
    letter-spacing:0.5px;
  }
  
  input {
    width:100%;
    padding:12px;
    font-size:16px;
    border:none;
    border-radius:10px;
    margin-bottom:12px;
    background:#3a3a3c;
    color:#fff;
    font-family:inherit;
  }
  
  input::placeholder {
    color:#636366;
  }
  
  button {
    background:var(--blue); 
    color:white; 
    border:none; 
    border-radius:12px;
    padding:14px 24px; 
    font-size:17px; 
    font-weight:600; 
    cursor:pointer;
    width:100%;
  }
  button:disabled { background:#3a3a3c; color:#636366; cursor:not-allowed; }

  table { 
    width:100%; 
    border-collapse:collapse; 
    margin-top:10px;
    font-size:13px;
  }
  th, td { 
    padding:10px 6px; 
    text-align:left; 
    border-bottom:1px solid #3a3a3c;
  }
  th { 
    background:#3a3a3c; 
    font-weight:600;
    font-size:11px;
    text-transform:uppercase;
    letter-spacing:0.5px;
    color:#8e8e93;
  }
  
  td {
    color:#f5f5f5;
  }
  
  #trial-table-container h2,
  #results-container h2 {
    font-size:20px;
    font-weight:600;
    margin-bottom:12px;
    color:#fff;
  }
  
  .start-button-container {
    text-align:center;
    margin:30px 0 40px;
  }
  
  #start {
    font-size:18px;
    padding:16px 40px;
  }
  
  #download-csv {
    margin-top:16px;
    font-size:16px;
    padding:14px 32px;
  }

  #load-results {
    margin-top:10px;
    background:#3a3a3c;
    color:#fff;
  }
</style>
</style>
</head>
<body>

<div class="phone">
  <div class="container">
    <h1>Alarm Study<br><small>Scroll vs Radial Clock-Wheel</small></h1>

    <div class="config">
      <div>
        <label>Participant ID</label>
        <input id="pid" value="P001">
      </div>
      <div>
        <label>Participant block order</label>
        <select id="block-order">
          <option value="scroll-first">Scroll first, then Radial Clock-Wheel</option>
          <option value="radial-first">Radial Clock-Wheel first, then Scroll</option>
        </select>
      </div>
      <div>
        <label>Seed (optional)</label>
        <input id="seed" placeholder="random">
      </div>
      <p style="font-size:12px; color:#8e8e93; margin-top:8px;">36 trials total (2 reps × 18 conditions • ~39 min)</p>
      <button id="gen">Generate Trial Order</button>
    </div>

    <div id="trial-table-container" style="display:none;">
      <h2>Trial Order</h2>
      <table id="trial-table">
        <thead><tr><th>#</th><th>Tech</th><th>Len</th><th>Pos</th><th>Rep</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="start-button-container">
      <button id="start" disabled>Start Experiment</button>
    </div>

    <div id="results-container" style="display:none;">
      <h2>Results</h2>
      <table id="results-table">
        <thead><tr><th>PID</th><th>Tech</th><th>Len</th><th>Pos</th><th>Rep</th><th>Trial</th><th>Start</th><th>Duration_ms</th><th>Errors</th><th>Mental</th><th>Target</th></tr></thead>
        <tbody></tbody>
      </table>
      <button id="load-results">Load latest results</button>
      <button id="download-csv">Download CSV</button>
    </div>
  </div>
</div>

<script>
const state = { trials: [], idx: 0, results: [], participantId: '' };
const mulberry32 = s => { let a=s>>>0; return()=>(a+=0x6D2B79F5,a^=a>>>15,a=Math.imul(a,a|1),a^=a+Math.imul(a^a>>>7,a|61),((a^a>>>14)>>>0)/4294967296); };

// Generate trials
document.getElementById('gen').onclick = () => {
  const reps = parseInt(document.getElementById('reps').value)||1;
  const seed = document.getElementById('seed').value.trim()==='' ? Math.random()*4294967295 : +document.getElementById('seed').value;
  const rng = mulberry32(seed);

  const conditions = [];
  ['Radial Clock-Wheel','Scroll'].forEach(tech=>[10,20,30].forEach(len=>['Top','Middle','Bottom'].forEach(pos=>conditions.push({tech,len,pos}))));

  const all = [];
  conditions.forEach(c=>{for(let i=1;i<=reps;i++)all.push({...c,rep:i});});

  const blocks = {'Radial Clock-Wheel':[],'Scroll':[]};
  all.forEach(t=>blocks[t.tech].push(t));

  const ordered = [];
  ['Radial Clock-Wheel','Scroll'].forEach(tech=>{
    const b = blocks[tech];
    for(let i=b.length-1;i>0;i--){
      const j=Math.floor(rng()*(i+1));
      [b[i],b[j]]=[b[j],b[i]];
    }
    ordered.push(...b);
  });

  state.trials = ordered; 
  state.idx=0; 
  state.results=[];
  state.participantId = document.getElementById('pid').value;
  
  const tbody = document.querySelector('#trial-table tbody');
  tbody.innerHTML=''; 
  state.trials.forEach((t,i)=>{ 
    const tr=document.createElement('tr'); 
    tr.innerHTML=`<td>${i+1}</td><td>${t.tech}</td><td>${t.len}</td><td>${t.pos}</td><td>${t.rep}</td>`; 
    tbody.appendChild(tr); 
  });

  document.getElementById('trial-table-container').style.display='block';
  document.getElementById('start').disabled=false;
  alert(`Generated ${state.trials.length} trials (Block 1: 9 trials • Block 2: 9 trials)`);
};

// Start → redirect to experiment.html with trial data
document.getElementById('start').onclick = () => {
  // Store trial configuration in sessionStorage
  sessionStorage.setItem('experimentTrials', JSON.stringify(state.trials));
  sessionStorage.setItem('participantId', state.participantId);
  
  // Redirect to experiment.html
  window.location.href = 'experiment.html';
};

// Results display
function showResults(){
  const tbody = document.querySelector('#results-table tbody');
  tbody.innerHTML = '';
  
  state.results.forEach(r => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${r.participant}</td>
      <td>${r.technique}</td>
      <td>${r.list_length}</td>
      <td>${r.target_position}</td>
      <td>${r.rep}</td>
      <td>${r.trial}</td>
      <td>${r.start_time}</td>
      <td>${r.duration_ms}</td>
      <td>${r.errors}</td>
      <td>${r.mental_effort}</td>
      <td>${r.target_time}</td>
    `;
    tbody.appendChild(tr);
  });
}

function loadStoredResults() {
  const storedSession = JSON.parse(sessionStorage.getItem('experimentResults') || '[]');
  const storedLocal = JSON.parse(localStorage.getItem('experimentResults') || '[]');
  const stored = storedSession.length ? storedSession : storedLocal;
  if (!stored.length) return;
  state.results = stored;
  showResults();
  document.getElementById('results-container').style.display='block';
}

// CSV Download
document.getElementById('download-csv').onclick = () => {
  const headers = ['ParticipantID','Technique','ListLength','TargetPosition','RepNo','TrialNo','StartTime','EndTime','Duration_ms','MentalEffort','ErrorCount','TargetTime'];
  const rows = state.results.map(r => [
    r.participant, r.technique, r.list_length, r.target_position, r.rep, r.trial,
    r.start_time, r.end_time, r.duration_ms, r.mental_effort, r.errors, r.target_time
  ]);
  
  const csv = [headers, ...rows].map(row => row.join(',')).join('\n');
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `alarm_study_${state.participantId}_${new Date().toISOString().slice(0,10)}.csv`;
  a.click();
  URL.revokeObjectURL(url);
};

document.getElementById('load-results').onclick = loadStoredResults;

// auto-load stored results on page visit
loadStoredResults();
</script>
</body>
</html>
