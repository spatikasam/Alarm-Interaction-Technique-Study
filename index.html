<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>Scroll vs Radial Clock-Wheel – Alarm Study</title>
<style>
  :root { --blue:#007aff; --red:#ff3b30; --green:#34c759; }
  * { box-sizing:border-box; margin:0; padding:0; }
  body {
    font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text",system-ui,sans-serif;
    background:#000;
    display:flex;
    justify-content:center;
    align-items:center;
    min-height:100vh;
    overflow-x:hidden;
  }
  
  .phone {
    width:390px;
    max-width:100vw;
    height:844px;
    max-height:100vh;
    background:#1c1c1e;
    overflow-y:auto;
    overflow-x:hidden;
    color:#f5f5f5;
    position:relative;
  }

  .container { 
    padding:20px;
    width:100%;
  }

  h1 { 
    text-align:center; 
    font-size:18px; 
    font-weight:700; 
    margin:20px 0 6px;
    color:#fff;
  }
  
  h1 small {
    display:block;
    font-weight:400;
    font-size:14px;
    color:#8e8e93;
    margin-top:4px;
    margin-bottom:12px;
  }
  
  .config, #trial-table-container, #results-container {
    background:#2c2c2e; 
    border-radius:16px; 
    padding:16px; 
    margin:16px 0;
  }
  
  label {
    display:block;
    font-size:12px;
    font-weight:600;
    color:#8e8e93;
    margin-bottom:6px;
    text-transform:uppercase;
    letter-spacing:0.5px;
  }
  
  input {
    width:100%;
    padding:12px;
    font-size:16px;
    border:none;
    border-radius:10px;
    margin-bottom:12px;
    background:#3a3a3c;
    color:#fff;
    font-family:inherit;
  }

  select {
    width:100%;
    padding:12px;
    font-size:16px;
    border:none;
    border-radius:10px;
    margin-bottom:12px;
    background:#3a3a3c;
    color:#fff;
    font-family:inherit;
    appearance:none;
    background-image: linear-gradient(45deg, transparent 50%, #8e8e93 50%),
                      linear-gradient(135deg, #8e8e93 50%, transparent 50%);
    background-position: calc(100% - 18px) 50%, calc(100% - 12px) 50%;
    background-size: 6px 6px, 6px 6px;
    background-repeat: no-repeat;
  }

  .config > div {
    margin-bottom:12px;
  }
  
  input::placeholder {
    color:#636366;
  }
  
  button {
    background:var(--blue); 
    color:white; 
    border:none; 
    border-radius:12px;
    padding:14px 24px; 
    font-size:17px; 
    font-weight:600; 
    cursor:pointer;
    width:100%;
    margin-top:16px;
  }
  button:disabled { background:#3a3a3c; color:#636366; cursor:not-allowed; }

  table { 
    width:100%; 
    border-collapse:collapse; 
    margin-top:10px;
    font-size:13px;
  }
  th, td { 
    padding:10px 6px; 
    text-align:left; 
    border-bottom:1px solid #3a3a3c;
  }
  th { 
    background:#3a3a3c; 
    font-weight:600;
    font-size:11px;
    text-transform:uppercase;
    letter-spacing:0.5px;
    color:#8e8e93;
  }
  
  td {
    color:#f5f5f5;
  }
  
  #trial-table-container h2,
  #results-container h2 {
    font-size:20px;
    font-weight:600;
    margin-bottom:12px;
    color:#fff;
  }
  
  .start-button-container {
    text-align:center;
    margin:30px 0 40px;
  }
  
  #start {
    font-size:18px;
    padding:16px 40px;
  }
  
  #download-csv {
    margin-top:16px;
    font-size:16px;
    padding:14px 32px;
  }

  #load-results {
    margin-top:10px;
    background:#3a3a3c;
    color:#fff;
  }
</style>
</style>
</head>
<body>

<div class="phone">
  <div class="container">
    <h1>Alarm Study: Scroll vs Radial Clock-Wheel</h1>

    <div class="config">
      <div>
        <label>Participant ID</label>
        <input id="pid" value="P001">
      </div>
      <p style="font-size:12px; color:#8e8e93; margin-top:8px;">54 logged trials + 4 practice (3 blocks × 18 conditions • ~32-36 min)</p>
      <button id="gen">Generate Trial Order</button>
    </div>

    <div id="trial-table-container" style="display:none;">
      <h2>Trial Order</h2>
      <table id="trial-table">
        <thead><tr><th>Trial#</th><th>Block</th><th>Tech</th><th>Len</th><th>Pos</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="start-button-container">
      <button id="start" disabled>Start Experiment</button>
    </div>

    <div id="results-container" style="display:none;">
      <h2>Results</h2>
      <table id="results-table">
        <thead><tr><th>PID</th><th>Tech</th><th>Len</th><th>Pos</th><th>Block</th><th>Trial</th><th>Start</th><th>Duration_ms</th><th>Errors</th><th>Mental</th><th>Target</th></tr></thead>
        <tbody></tbody>
      </table>
      <button id="load-results">Load latest results</button>
      <button id="download-csv">Download CSV</button>
    </div>
  </div>
</div>

<script>
const state = { trials: [], idx: 0, results: [], participantId: '' };
const mulberry32 = s => { let a=s>>>0; return()=>(a+=0x6D2B79F5,a^=a>>>15,a=Math.imul(a,a|1),a^=a+Math.imul(a^a>>>7,a|61),((a^a>>>14)>>>0)/4294967296); };

// Generate trials (3 blocks × 18 conditions + 4 practice trials)
document.getElementById('gen').onclick = () => {
  // 3×3×2 = 18 conditions (ListLength × TargetPosition × Technique)
  const conditions = [];
  const techniques = ['Scroll', 'Radial Clock-Wheel'];
  const lengths = [10, 20, 30];
  const positions = ['Top', 'Middle', 'Bottom'];
  
  techniques.forEach(tech => 
    lengths.forEach(len => 
      positions.forEach(pos => 
        conditions.push({ tech, len, pos })
      )
    )
  );
  
  const seed = Math.random() * 4294967295;
  const rng = mulberry32(seed);
  
  // Fisher-Yates shuffle utility
  const shuffle = (arr, rng) => {
    const copy = [...arr];
    for (let i = copy.length - 1; i > 0; i--) {
      const j = Math.floor(rng() * (i + 1));
      [copy[i], copy[j]] = [copy[j], copy[i]];
    }
    return copy;
  };
  
  // 4 fixed practice trials (not logged)
  const practice = [
    { tech: 'Scroll', len: 10, pos: 'Top', isPractice: true },
    { tech: 'Scroll', len: 10, pos: 'Middle', isPractice: true },
    { tech: 'Radial Clock-Wheel', len: 10, pos: 'Top', isPractice: true },
    { tech: 'Radial Clock-Wheel', len: 10, pos: 'Bottom', isPractice: true }
  ];
  
  // 3 blocks × 18 conditions = 54 logged trials
  const allTrials = [];
  let trialNo = 1; // session-level trial counter (doesn't count practice)
  
  for (let block = 1; block <= 3; block++) {
    const shuffled = shuffle(conditions, rng);
    shuffled.forEach(cond => {
      allTrials.push({
        ...cond,
        blockNo: block,
        trialNo: trialNo,
        isPractice: false
      });
      trialNo++;
    });
  }
  
  // Combine: practice first (not logged), then 54 logged trials
  state.trials = [...practice, ...allTrials];
  state.idx = 0;
  state.results = [];
  state.participantId = document.getElementById('pid').value;
  
  // Display trial table (only logged trials)
  const tbody = document.querySelector('#trial-table tbody');
  tbody.innerHTML = '';
  allTrials.slice(0, 18).forEach((t, i) => { // Show first block as preview
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${t.trialNo}</td><td>${t.blockNo}</td><td>${t.tech}</td><td>${t.len}</td><td>${t.pos}</td>`;
    tbody.appendChild(tr);
  });
  
  document.getElementById('trial-table-container').style.display = 'block';
  document.getElementById('start').disabled = false;
  alert(`Generated 58 total trials:\n  • 4 practice trials (not logged)\n  • 54 logged trials (3 blocks × 18 conditions)`);
};

// Start → redirect to practice.html with trial data
document.getElementById('start').onclick = () => {
  // Store trial configuration in sessionStorage (only logged trials, no practice)
  const loggedTrials = state.trials.filter(t => !t.isPractice);
  sessionStorage.setItem('experimentTrials', JSON.stringify(loggedTrials));
  sessionStorage.setItem('participantId', state.participantId);
  
  // Redirect to practice.html first
  window.location.href = 'practice.html';
};

// Results display
function showResults(){
  const tbody = document.querySelector('#results-table tbody');
  tbody.innerHTML = '';
  
  state.results.forEach(r => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${r.participantId}</td>
      <td>${r.technique}</td>
      <td>${r.listLength}</td>
      <td>${r.targetPosition}</td>
      <td>${r.blockNo}</td>
      <td>${r.trialNo}</td>
      <td>${r.startTime}</td>
      <td>${r.durationMs}</td>
      <td>${r.errorCount}</td>
      <td>${r.mentalEffort}</td>
      <td>${r.targetTime}</td>
    `;
    tbody.appendChild(tr);
  });
}

function loadStoredResults() {
  const storedSession = JSON.parse(sessionStorage.getItem('experimentResults') || '[]');
  const storedLocal = JSON.parse(localStorage.getItem('experimentResults') || '[]');
  const stored = storedSession.length ? storedSession : storedLocal;
  if (!stored.length) return;
  state.results = stored;
  showResults();
  document.getElementById('results-container').style.display='block';
}

// CSV Download
document.getElementById('download-csv').onclick = () => {
  const headers = ['ParticipantID','Technique','ListLength','TargetPosition','BlockNo','TrialNo','StartTime','EndTime','Duration_ms','MentalEffort','ErrorCount','TargetTime'];
  const rows = state.results.map(r => [
    r.participantId, r.technique, r.listLength, r.targetPosition, r.blockNo, r.trialNo,
    r.startTime, r.endTime, r.durationMs, r.mentalEffort, r.errorCount, r.targetTime
  ]);
  
  const csv = [headers, ...rows].map(row => row.join(',')).join('\n');
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `alarm_study_${state.participantId}_${new Date().toISOString().slice(0,10)}.csv`;
  a.click();
  URL.revokeObjectURL(url);
};

document.getElementById('load-results').onclick = loadStoredResults;

// auto-load stored results on page visit
loadStoredResults();
</script>
</body>
</html>
