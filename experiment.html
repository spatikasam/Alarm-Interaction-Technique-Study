<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Alarm Dial Navigation Experiment</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <div class="phone">
    <div class="status-bar">
      <div class="status-time">9:41</div>
      <div class="status-right">
        <svg class="status-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M1 9l2 2c4.97-4.97 13.03-4.97 18 0l2-2C16.93 2.93 7.08 2.93 1 9zm8 8l3 3 3-3c-1.65-1.66-4.34-1.66-6 0zm-4-4l2 2c2.76-2.76 7.24-2.76 10 0l2-2C15.14 9.14 8.87 9.14 5 13z"/></svg>
        <svg class="status-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M15.67 4H14V2h-4v2H8.33C7.6 4 7 4.6 7 5.33v15.34C7 21.4 7.6 22 8.33 22h7.34c.73 0 1.33-.6 1.33-1.33V5.33C19 4.6 18.4 4 17.67 4zm.33 16H8V6h8v14z"/></svg>
      </div>
    </div>

    <div class="header">
      <div class="header-left">Edit</div>
      <div class="header-subtitle" id="header-subtitle">Block 1 ‚Ä¢ Trial 1 of 58 ‚Ä¢ Radial Clock-Wheel</div>
      <div class="header-plus">+</div>
    </div>

    <div class="alarms-scroll" id="alarmsScroll"></div>

    <div class="dial-container">
      <div class="dial" id="dial">
        <div class="dial-am-label">
          <svg class="label-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="5"></circle>
            <line x1="12" y1="1" x2="12" y2="3"></line>
            <line x1="12" y1="21" x2="12" y2="23"></line>
            <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
            <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
            <line x1="1" y1="12" x2="3" y2="12"></line>
            <line x1="21" y1="12" x2="23" y2="12"></line>
            <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
            <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
          </svg>
          AM
        </div>
        <div class="dial-pm-label">
          <svg class="label-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
          </svg>
          PM
        </div>
      </div>
      <div class="dial-pointer"></div>
    </div>

    <div id="trial-modal" class="trial-modal hidden">
      <div class="trial-modal-content">
        <h2 id="modal-title">Target alarm</h2>
        <p id="modal-body">Turn off the target alarm.</p>
        <ul class="modal-steps">
          <li>Note the target alarm time below.</li>
          <li>Use the shown technique to find and turn it off.</li>
          <li>Only turn off that alarm; others count as errors.</li>
        </ul>
        <button id="modal-start" class="pill-btn">Begin trial</button>
      </div>
    </div>

    <!-- Effort Rating Modal -->
    <div id="effort-modal" class="trial-modal hidden">
      <div class="trial-modal-content">
        <h2>Mental effort</h2>
        <p>How mentally demanding was this task?</p>
        <p style="font-size: 13px; color: #8e8e93; margin-top: -8px;">(0 = very low, 100 = very high)</p>
        <input id="effort-slider" type="range" min="0" max="100" value="50" style="margin: 20px 0 8px 0;" />
        <div class="slider-labels">
          <span>0</span><span>25</span><span>50</span><span>75</span><span>100</span>
        </div>
        <button id="effort-submit" class="pill-btn">Submit rating</button>
      </div>
    </div>
    
    <!-- Timer Display -->
    <div class="timer-display hidden" id="timer-display">--</div>
    
    <!-- Trial Info Bar (target + timer) -->
    <div class="trial-info-bar hidden" id="trial-info-bar">
      <div class="target-reminder">
        <div class="target-label">Target</div>
        <div class="target-time" id="target-time-reminder">--:-- AM</div>
      </div>
      <div class="timer-display" id="timer-countdown">30s</div>
    </div>
    
    <!-- Break Overlay -->
    <div class="break-overlay hidden" id="break-overlay">
      <div>Take a break</div>
      <div class="break-countdown" id="break-countdown">60</div>
      <div style="font-size: 14px; color: #8e8e93;">Resuming soon...</div>
    </div>
    
    <!-- Intro Modal -->
    <div id="intro-modal" class="trial-modal">
      <div class="trial-modal-content">
        <h2>Main Experiment</h2>
        <p style="margin-bottom: 20px;">You are about to begin the main study.</p>
        <div style="background: rgba(255,255,255,0.05); padding: 16px; border-radius: 12px; margin-bottom: 20px;">
          <div style="font-size: 13px; color: #8e8e93; margin-bottom: 8px;">STUDY DETAILS</div>
          <div style="font-size: 15px; line-height: 1.6;">
            <div><strong>54 trials</strong> across <strong>3 blocks</strong></div>
            <div style="margin-top: 6px; font-size: 13px; color: #d1d1d1;">18 trials per block with breaks between blocks</div>
          </div>
        </div>
        <p style="font-size: 14px; color: #d1d1d1;">All data will be logged. Take your time and focus on accuracy.</p>
        <button id="intro-start" class="pill-btn">Begin Experiment</button>
      </div>
    </div>
    
    <!-- Post-Experiment Screen -->
    <div id="post-screen" class="trial-modal hidden">
      <div class="trial-modal-content">
        <h2>Study Complete!</h2>
        <p>Thank you for completing all trials.</p>
        <p style="margin-top: 20px;">Your data has been saved automatically.</p>
        <button id="return-home" class="pill-btn">Return to Setup Page</button>
      </div>
    </div>
  </div>

  <script src="script.js"></script>
  <script>
    (() => {
    // ============ CONFIG ============
    const SHEET_URL = 'https://script.google.com/macros/s/AKfycbyD_2E9oY5yyM3PeA6OBS0ArmAN_HLSMb5gPhBuPErkZm74mD-0HlrzG9Ia0JqGwk3M/exec';

    // ============ STATE ============
    const store = {
      trials: JSON.parse(sessionStorage.getItem('experimentTrials') || '[]'),
      pid: sessionStorage.getItem('participantId') || 'P000',
      results: JSON.parse(sessionStorage.getItem('experimentResults') || localStorage.getItem('experimentResults') || '[]'),
      idx: 0,
      trial: null,
      target: null,
      errors: 0,
      active: false,
      startTime: 0,
      pending: null,
      timerInterval: null,
      breakInterval: null,
      timedOut: false,
      trialStartIso: null
    };

    if (!store.trials.length) {
      store.trials = [
        { tech: 'Radial Clock-Wheel', len: 10, pos: 'Top', rep: 1, blockNo: 1, trialNo: 1 },
        { tech: 'Scroll', len: 10, pos: 'Bottom', rep: 1, blockNo: 1, trialNo: 2 }
      ];
    }    // ============ ALARM POOL ============
    const alarms = (() => {
      const pool = [];
      const labs = [
        'Wake up',      // 0 (12 AM)
        'Night shift',  // 1 AM
        'Early gym',    // 2 AM
        'Airport',      // 3 AM
        'Baking',       // 4 AM
        'Morning run',  // 5 AM
        'Meditation',   // 6 AM
        'Breakfast',    // 7 AM
        'Work start',   // 8 AM
        'Meeting',      // 9 AM
        'Coffee break', // 10 AM
        'Team standup', // 11 AM
        'Lunch',        // 12 PM
        'Appointment',  // 1 PM
        'Project review', // 2 PM
        'Call client',  // 3 PM
        'Gym class',    // 4 PM
        'Pick up kids', // 5 PM
        'Dinner prep',  // 6 PM
        'Dinner',       // 7 PM
        'Walk dog',     // 8 PM
        'TV show',      // 9 PM
        'Read',         // 10 PM
        'Bedtime'       // 11 PM
      ];
      const minutes = [0, 30];
      
      for (let h = 0; h < 24; h++) {
        const min = minutes[Math.floor(Math.random() * minutes.length)];
        pool.push({ h, min, label: labs[h] });
      }
      return pool;
    })();

    // Build alarms for current trial and refresh dial
    function buildAlarmList(trial, targetIdx) {
      const list = alarms.slice(0, trial.len);
      
      if (!dom.scroll) return;
      
      dom.scroll.innerHTML = '';
      dom.scroll.scrollTop = 0;  // Reset scroll to top
      
      // Randomly turn on 30-50% of alarms (not including target)
      const numOn = Math.floor(trial.len * (0.3 + Math.random() * 0.2));
      const onIndices = new Set();
      while (onIndices.size < numOn) {
        const randomIdx = Math.floor(Math.random() * trial.len);
        if (randomIdx !== targetIdx) {
          onIndices.add(randomIdx);
        }
      }

      list.forEach((a, i) => {
        const { time, ap } = fmt.time(a);
        const isTarget = i === targetIdx;
        const isOn = isTarget || onIndices.has(i);
        const row = document.createElement('div');
        row.className = 'alarm-row';
        row.dataset.h = a.h;
        row.dataset.isTarget = isTarget;
        row.innerHTML = `
          <div class="alarm-left">
            <div><span class="alarm-time">${time}</span><span class="alarm-am">${ap}</span></div>
            <div class="alarm-label">${a.label}</div>
          </div>
          <div class="alarm-toggle ${isOn ? 'on' : 'off'}" data-h="${a.h}"></div>
        `;
        dom.scroll.appendChild(row);
      });

      if (window.alarmDial) {
        window.alarmDial.refresh();
      }
    }

    // ============ UTILS ============
    // NOTE: Target positions refer to list portions, NOT literal top/bottom of screen
    // "Top"    = random alarm in top 1/3 of the list
    // "Middle" = random alarm in middle 1/3 of the list
    // "Bottom" = random alarm in bottom 1/3 of the list
    const fmt = {
      time: (a) => {
        const h12 = a.h === 0 ? 12 : a.h > 12 ? a.h - 12 : a.h;
        const ap = a.h < 12 ? 'AM' : 'PM';
        const minStr = (a.min || a.m || 0).toString().padStart(2, '0');
        return { time: `${h12}:${minStr}`, ap, full: `${h12}:${minStr} ${ap}`, h: a.h };
      },
      // Calculates target alarm index based on position in list
      // Top: random index in first 1/3 of list
      // Middle: random index in middle 1/3 of list
      // Bottom: random index in last 1/3 of list
      target: (pos, len) => {
        const third = Math.ceil(len / 3);
        let start, end;
        
        if (pos === 'Top') {
          start = 0;
          end = Math.min(third - 1, len - 1);
        } else if (pos === 'Bottom') {
          start = Math.max(len - third, 0);
          end = len - 1;
        } else { // Middle
          start = Math.ceil(len / 3);
          end = Math.floor(2 * len / 3) - 1;
        }
        
        // Pick random index within the range
        return start + Math.floor(Math.random() * (end - start + 1));
      }
    };

    // ============ DOM ============
    const dom = {
      scroll: document.getElementById('alarmsScroll'),
      dial: document.querySelector('.dial-container'),
      modal: document.getElementById('trial-modal'),
      mTitle: document.getElementById('modal-title'),
      mBody: document.getElementById('modal-body'),
      mStart: document.getElementById('modal-start'),
      effort: document.getElementById('effort-modal'),
      slider: document.getElementById('effort-slider'),
      submit: document.getElementById('effort-submit'),
      timerDisplay: document.getElementById('timer-display'),
      timerCountdown: document.getElementById('timer-countdown'),
      trialInfoBar: document.getElementById('trial-info-bar'),
      targetTimeReminder: document.getElementById('target-time-reminder'),
      breakOverlay: document.getElementById('break-overlay'),
      breakCountdown: document.getElementById('break-countdown'),
      introModal: document.getElementById('intro-modal'),
      introStart: document.getElementById('intro-start'),
      post: document.getElementById('post-screen'),
      returnHome: document.getElementById('return-home')
    };
    

    
    // Alias for backwards compatibility
    dom.next = dom.submit;
    dom.note = document.querySelector('.footer-note') || { textContent: '' };
    
    // Intro modal handler
    dom.introStart.onclick = () => {
      dom.introModal.classList.add('hidden');
      renderTrial();
    };

    // ============ TIMER & BREAK UTILITIES ============
    function startTimer() {
      const TIMEOUT_MS = 30000; // 30 seconds
      const TOTAL_SECONDS = 30;
      store.timedOut = false;
      store.startTime = Date.now();
      
      if (store.timerInterval) clearInterval(store.timerInterval);
      
      store.timerInterval = setInterval(() => {
        const elapsed = Math.floor((Date.now() - store.startTime) / 1000);
        const remaining = Math.max(0, TOTAL_SECONDS - elapsed);
        
        if (dom.timerCountdown) {
          dom.timerCountdown.textContent = `${remaining}s`;
          dom.timerCountdown.classList.remove('warning', 'timeout');
          
          if (remaining <= 5 && remaining > 0) {
            dom.timerCountdown.classList.add('warning');
          } else if (remaining === 0) {
            dom.timerCountdown.classList.add('timeout');
          }
        }
        
        // Hard timeout at 30s
        if (elapsed >= 30) {
          clearInterval(store.timerInterval);
          store.timedOut = true;
          finalizeTrial();
        }
      }, 100);
    }
    
    function stopTimer() {
      if (store.timerInterval) {
        clearInterval(store.timerInterval);
        store.timerInterval = null;
      }
      // Just hide the timer countdown, keep the target reminder visible during effort modal
      if (dom.timerCountdown) {
        dom.timerCountdown.textContent = '';  // Clear timer display
        dom.timerCountdown.classList.remove('warning', 'timeout');
      }
    }
    
    function showBreak(durationSec, isBlockBreak = false) {
      return new Promise(resolve => {
        if (dom.breakOverlay) {
          let breakTitle = isBlockBreak ? 'üéØ Block Break' : '‚è∏Ô∏è Brief Pause';
          let breakInfo = '';
          
          if (isBlockBreak && store.idx < store.trials.length) {
            // For block breaks, show completed block and starting block on separate lines
            const nextTrial = store.trials[store.idx];
            const completedBlock = nextTrial.blockNo - 1;
            const startingBlock = nextTrial.blockNo;
            breakInfo = `
              <div style="font-size: 13px; color: #8e8e93;">Block ${completedBlock} complete</div>
              <div style="font-size: 13px; color: #8e8e93;">Starting Block ${startingBlock}</div>
            `;
          } else if (!isBlockBreak && store.idx < store.trials.length) {
            // For regular breaks, show trial progress within block
            const nextTrial = store.trials[store.idx];
            
            // Count trials in current block for "x of y" within block
            const trialsInBlock = store.trials.filter(t => t.blockNo === nextTrial.blockNo).length;
            const trialIndexInBlock = store.trials
              .slice(0, store.idx)
              .filter(t => t.blockNo === nextTrial.blockNo).length + 1;
            
            breakInfo = `<div style="font-size: 13px; color: #8e8e93; margin-bottom: 8px;">Block ${nextTrial.blockNo} ‚Ä¢ Trial ${trialIndexInBlock} of ${trialsInBlock}</div>`;
          }
          
          dom.breakOverlay.innerHTML = `
            <div style="font-size: 18px; font-weight: 600; margin-bottom: 12px;">${breakTitle}</div>
            ${breakInfo}
            <div class="break-countdown" id="break-countdown">${durationSec}s</div>
            <div style="font-size: 13px; color: #8e8e93; margin-top: 8px;">Resuming in...</div>
          `;
          dom.breakOverlay.classList.remove('hidden');
        }
        
        let remaining = durationSec;
        if (store.breakInterval) clearInterval(store.breakInterval);
        
        store.breakInterval = setInterval(() => {
          remaining--;
          const countdown = document.getElementById('break-countdown');
          if (countdown) countdown.textContent = remaining + 's';
          
          if (remaining <= 0) {
            clearInterval(store.breakInterval);
            if (dom.breakOverlay) dom.breakOverlay.classList.add('hidden');
            resolve();
          }
        }, 1000);
      });
    }

    // ============ RENDER ============
    function renderTrial() {
      if (store.idx >= store.trials.length) {
        return showPostQuestionnaire();
      }

      store.trial = store.trials[store.idx];
      
      const list = alarms.slice(0, store.trial.len);
      const tIdx = fmt.target(store.trial.pos, list.length);
      store.target = list[tIdx];
      store.errors = 0;
      store.active = false;
      store.pending = null;

      // Update header subtitle with block and trial info
      if (document.getElementById('header-subtitle')) {
        document.getElementById('header-subtitle').textContent = `Block ${store.trial.blockNo} ‚Ä¢ Trial ${store.idx + 1} of ${store.trials.length} ‚Ä¢ ${store.trial.tech}`;
      }

      buildAlarmList(store.trial, tIdx);

      const useDial = store.trial.tech === 'Radial Clock-Wheel';
      dom.dial.style.display = useDial ? 'block' : 'none';
      if (window.alarmDial) {
        window.alarmDial.setActive(useDial);
        if (useDial) {
          const dialContainer = document.querySelector('.dial-container');
          if (dialContainer) {
            dialContainer.classList.add('open');
          }
          window.alarmDial.setRotationLock(false);  // Unlock rotation for Radial trials
        } else {
          const dialContainer = document.querySelector('.dial-container');
          if (dialContainer) {
            dialContainer.classList.remove('open');
          }
          window.alarmDial.setRotationLock(true);  // Lock rotation for Scroll trials
        }
      }

      const t = fmt.time(store.target);
      dom.mTitle.textContent = `Target alarm`;
      dom.mBody.textContent = `Find and turn OFF this alarm:

‚è∞ ${t.full} - ${store.target.label}

Technique: ${store.trial.tech}`;
      dom.mBody.style.whiteSpace = 'pre-line';
      dom.mBody.style.fontSize = '16px';
      dom.mBody.style.fontWeight = '600';
      // Don't show trial modal - go straight to trial
      // dom.modal.classList.remove('hidden');
      
      // Start trial immediately
      store.active = true;
      store.trialStartIso = new Date().toISOString();
      
      // Show target reminder and timer
      dom.targetTimeReminder.textContent = t.full;
      dom.trialInfoBar.classList.remove('hidden');
      
      startTimer();

      dom.submit.disabled = true;
      dom.submit.textContent = 'Submit rating';
    }
    
    function showPostQuestionnaire() {
      // Hide trial UI
      dom.modal.classList.add('hidden');
      dom.effort.classList.add('hidden');
      dom.dial.style.display = 'none';
      document.getElementById('alarmsScroll').style.display = 'none';
      
      // Show post-experiment screen
      const postScreen = document.getElementById('post-screen');
      if (postScreen) {
        postScreen.classList.remove('hidden');
      }
    }

    // ============ EVENTS ============
    dom.mStart.onclick = () => {
      dom.modal.classList.add('hidden');
      store.active = true;
      store.trialStartIso = new Date().toISOString();
      
      // Show target reminder and timer
      const t = fmt.time(store.target);
      dom.targetTimeReminder.textContent = t.full;
      dom.trialInfoBar.classList.remove('hidden');
      
      startTimer();
    };

    dom.scroll.addEventListener('click', (e) => {
      const toggle = e.target.closest('.alarm-toggle');
      if (!toggle || !store.active) return;

      const clickH = parseInt(toggle.dataset.h, 10);
      const wasOn = toggle.classList.contains('on');

      // Toggle the alarm on/off
      toggle.classList.toggle('on');
      toggle.classList.toggle('off');

      const row = toggle.closest('.alarm-row');
      const isTargetAlarm = clickH === store.target.h;
      
      if (isTargetAlarm && wasOn) {
        // Correct: turned OFF the target alarm
        stopTimer();
        store.active = false;
        
        // Visual feedback for correct alarm
        if (row) {
          row.style.transition = 'all 0.3s ease';
          row.style.backgroundColor = '#34c759';
          row.style.color = '#ffffff';
        }
        
        // Vibrate success pattern
        if (navigator.vibrate) {
          navigator.vibrate([50, 50, 50]);
        }
        
        setTimeout(() => {
          if (row) {
            row.style.backgroundColor = '';
            row.style.color = '';
          }
          
          const ms = Math.round(Date.now() - store.startTime);
          const endIso = new Date().toISOString();
          const t = fmt.time(store.target);

          store.pending = {
            participantId: store.pid,
            technique: store.trial.tech,
            listLength: store.trial.len,
            targetPosition: store.trial.pos,
            blockNo: store.trial.blockNo,
            trialNo: store.trial.trialNo,
            startTime: store.trialStartIso,
            endTime: endIso,
            durationMs: ms,
            errorCount: store.errors,
            mentalEffort: null,
            targetTime: t.full,
            isPractice: store.trial.isPractice || false
          };

          dom.slider.value = 50;
          dom.submit.disabled = false;  // ‚úÖ ENABLE button when showing effort modal
          dom.effort.classList.remove('hidden');
        }, 1000);
      } else if (clickH !== store.target.h) {
        // Error: toggled any wrong alarm (whether turning ON or OFF)
        store.errors += 1;
        
        // Visual feedback for wrong alarm
        if (row) {
          row.style.transition = 'all 0.2s ease';
          row.style.backgroundColor = '#ff3b30';
          row.style.color = '#ffffff';
          row.style.transform = 'scale(0.98)';
        }
        
        setTimeout(() => {
          if (row) {
            row.style.backgroundColor = '';
            row.style.color = '';
            row.style.transform = '';
          }
        }, 600);
        
        // Vibration feedback
        if (navigator.vibrate) navigator.vibrate([100, 50, 100]);
      }
    });

    // Submit button handler
    async function handleSubmitClick(e) {
      e.preventDefault();
      e.stopPropagation();
      
      if (dom.effort && !dom.effort.classList.contains('hidden')) {
        if (!store.pending) return;

        // Save effort rating
        store.pending.mentalEffort = parseInt(dom.slider.value, 10);
        
        // Log the result
        store.results.push(store.pending);
        const s = JSON.stringify(store.results);
        sessionStorage.setItem('experimentResults', s);
        localStorage.setItem('experimentResults', s);
        
        // Post to sheet
        post(store.pending);

        // Hide effort modal
        dom.effort.classList.add('hidden');
        
        // 3s inter-trial break
        await showBreak(3, false);
        
        store.idx += 1;
        
        // Check for block break (after trials 18 and 36)
        if ((store.idx === 18 || store.idx === 36) && store.idx < store.trials.length) {
          await showBreak(60, true);
        }
        
        // Reset slider for next trial
        dom.slider.value = 50;
        
        // Advance to next trial
        renderTrial();
      }
    }
    
    // Attach event listener
    if (dom.submit) {
      dom.submit.addEventListener('click', handleSubmitClick, false);
      dom.submit.onclick = (e) => {
        handleSubmitClick(e || window.event);
        return false;
      };
    }

    function finalizeTrial() {
      stopTimer();
      store.active = false;
      dom.modal.classList.add('hidden');
      // Hide the trial info bar after the trial is done
      if (dom.trialInfoBar) {
        dom.trialInfoBar.classList.add('hidden');
      }
    }

    // ============ SHEET ============
    async function post(row) {
      if (!SHEET_URL.startsWith('http')) return;
      
      try {
        await fetch(SHEET_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(row),
          mode: 'no-cors'
        });
      } catch (e) {
        // Silently fail - data is still saved locally
      }
    }

    // ============ FINISH ============
    function done() {
      dom.submit.disabled = true;
      dom.submit.textContent = 'All trials completed';
      alert('All trials completed. Return to the setup page to configure a new order.');
    }

    // ============ EXPORT ============
    document.addEventListener('keydown', (e) => {
      if (!e.altKey) return;
      if (e.key === 'E') exp('csv');
      if (e.key === 'J') exp('json');
    });

    function exp(fmt) {
      let content, name, type;
      if (fmt === 'csv') {
        const h = ['ParticipantID','Technique','ListLength','TargetPosition','BlockNo','TrialNo','StartTime','EndTime','Duration_ms','MentalEffort','ErrorCount','TargetTime'];
        const b = store.results.map(r => [r.participantId,r.technique,r.listLength,r.targetPosition,r.blockNo,r.trialNo,r.startTime,r.endTime,r.durationMs,r.mentalEffort ?? '',r.errorCount,r.targetTime]);
        content = [h, ...b].map(r => r.join(',')).join('\n');
        name = 'results.csv';
        type = 'text/csv';
      } else {
        content = JSON.stringify(store.results, null, 2);
        name = 'results.json';
        type = 'application/json';
      }
      const blob = new Blob([content], { type });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = name;
      a.click();
      URL.revokeObjectURL(url);
    }

    // ============ INIT ============
    console.log('üîç Checking sessionStorage for trials...');
    console.log('  experimentTrials:', sessionStorage.getItem('experimentTrials') ? 'Found' : 'Missing');
    console.log('  participantId:', sessionStorage.getItem('participantId') || 'Missing');
    
    if (store.trials.length === 0) {
      alert('No trials found. Please return to index.html and generate trials first.');
      console.error('‚ùå No trials in sessionStorage');
      window.location.href = 'index.html';
      return;
    }
    
    // Count trials
    const trialCount = store.trials.length;
    console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
    console.log('üß™ ALARM INTERACTION STUDY - MAIN EXPERIMENT');
    console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
    console.log(`‚úì Loaded ${trialCount} logged trials (3 blocks √ó 18)`);
    console.log(`‚úì Participant: ${store.pid}`);
    console.log(`‚úì First trial:`, store.trials[0]);
    console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
    console.log('üìã SEQUENCE:');
    console.log('  1. Block 1 (18 trials)');
    console.log('  2. Block 2 (18 trials)');
    console.log('  3. Block 3 (18 trials)');
    console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
    
    // Ensure intro modal is shown
    if (dom.introModal) {
      dom.introModal.classList.remove('hidden');
    }
    
    // Set up post-experiment return button
    const returnBtn = document.getElementById('return-home');
    if (returnBtn) {
      returnBtn.onclick = () => {
        window.location.href = 'index.html';
      };
    }
    
    // ‚úì VERIFICATION: 3-block factorial design
    console.log('‚úì 3-Block Factorial Design loaded');
    console.log('‚úì Trials:', store.trials.length, 'total');
    console.log('‚úì Participant:', store.pid);
    console.log('‚úì Design: 3 blocks √ó 18 conditions (2 techniques √ó 3 lengths √ó 3 positions)');
    console.log('‚úì Schema: ParticipantID, Technique, ListLength, TargetPosition, BlockNo, TrialNo, StartTime, EndTime, Duration_ms, MentalEffort, ErrorCount, TargetTime');
    console.log('‚úì Export shortcuts: Alt+E (CSV) | Alt+J (JSON)');
  })();
  </script>
</body>
</html>
