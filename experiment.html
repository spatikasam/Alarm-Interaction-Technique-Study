<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Alarm Dial Navigation Experiment</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <div class="phone">
    <div class="status-bar">
      <div class="status-time">9:41</div>
      <div class="status-right">
        <svg class="status-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M1 9l2 2c4.97-4.97 13.03-4.97 18 0l2-2C16.93 2.93 7.08 2.93 1 9zm8 8l3 3 3-3c-1.65-1.66-4.34-1.66-6 0zm-4-4l2 2c2.76-2.76 7.24-2.76 10 0l2-2C15.14 9.14 8.87 9.14 5 13z"/></svg>
        <svg class="status-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M15.67 4H14V2h-4v2H8.33C7.6 4 7 4.6 7 5.33v15.34C7 21.4 7.6 22 8.33 22h7.34c.73 0 1.33-.6 1.33-1.33V5.33C19 4.6 18.4 4 17.67 4zm.33 16H8V6h8v14z"/></svg>
      </div>
    </div>

    <div class="header">
      <div class="header-left">Edit</div>
      <div class="header-title">Alarm</div>
      <div class="header-plus">+</div>
    </div>

    <div class="alarms-scroll" id="alarmsScroll">
      <div class="alarm-row" data-hour="5">
        <div class="alarm-left">
          <div>
            <span class="alarm-time">5:00</span>
            <span class="alarm-am">AM</span>
          </div>
          <div class="alarm-label">Early Start</div>
        </div>
        <div class="switch"><div class="switch-knob"></div></div>
    </div>

      <div class="alarm-row" data-hour="5">
        <div class="alarm-left">
          <div>
            <span class="alarm-time">5:30</span>
            <span class="alarm-am">AM</span>
          </div>
          <div class="alarm-label">Backup</div>
        </div>
        <div class="switch"><div class="switch-knob"></div></div>
      </div>

      <div class="alarm-row" data-hour="6">
        <div class="alarm-left">
          <div>
            <span class="alarm-time">6:00</span>
            <span class="alarm-am">AM</span>
          </div>
          <div class="alarm-label">Wake Up</div>
        </div>
        <div class="switch"><div class="switch-knob"></div></div>
      </div>

      <div class="alarm-row" data-hour="6">
        <div class="alarm-left">
          <div>
            <span class="alarm-time">6:30</span>
            <span class="alarm-am">AM</span>
          </div>
          <div class="alarm-label">Snooze</div>
        </div>
        <div class="switch"><div class="switch-knob"></div></div>
      </div>

      <div class="alarm-row" data-hour="7">
        <div class="alarm-left">
          <div>
            <span class="alarm-time">7:00</span>
            <span class="alarm-am">AM</span>
          </div>
          <div class="alarm-label">Workout</div>
        </div>
        <div class="switch"><div class="switch-knob"></div></div>
      </div>

      <div class="alarm-row" data-hour="7">
        <div class="alarm-left">
          <div>
            <span class="alarm-time">7:30</span>
            <span class="alarm-am">AM</span>
          </div>
          <div class="alarm-label">Morning Exercise</div>
        </div>
        <div class="switch"><div class="switch-knob"></div></div>
      </div>

      <div class="alarm-row" data-hour="8">
        <div class="alarm-left">
          <div>
            <span class="alarm-time">8:00</span>
            <span class="alarm-am">AM</span>
          </div>
          <div class="alarm-label">Breakfast</div>
        </div>
        <div class="switch"><div class="switch-knob"></div></div>
      </div>

      <div class="alarm-row" data-hour="8">
        <div class="alarm-left">
          <div>
            <span class="alarm-time">8:15</span>
            <span class="alarm-am">AM</span>
          </div>
          <div class="alarm-label">Leave for Work</div>
        </div>
        <div class="switch"><div class="switch-knob"></div></div>
      </div>

      <div class="alarm-row" data-hour="9">
        <div class="alarm-left">
          <div>
            <span class="alarm-time">9:00</span>
            <span class="alarm-am">AM</span>
          </div>
          <div class="alarm-label">Morning Meeting</div>
        </div>
        <div class="switch"><div class="switch-knob"></div></div>
      </div>

      <div class="alarm-row" data-hour="10">
        <div class="alarm-left">
          <div>
            <span class="alarm-time">10:00</span>
            <span class="alarm-am">AM</span>
          </div>
          <div class="alarm-label">Coffee Break</div>
        </div>
        <div class="switch"><div class="switch-knob"></div></div>
      </div>

      <div class="alarm-row" data-hour="12">
        <div class="alarm-left">
          <div>
            <span class="alarm-time">12:00</span>
            <span class="alarm-am">PM</span>
          </div>
          <div class="alarm-label">Lunch Break</div>
        </div>
        <div class="switch"><div class="switch-knob"></div></div>
      </div>

      <div class="alarm-row" data-hour="12">
        <div class="alarm-left">
          <div>
            <span class="alarm-time">12:30</span>
            <span class="alarm-am">PM</span>
          </div>
          <div class="alarm-label">Medicine</div>
        </div>
        <div class="switch"><div class="switch-knob"></div></div>
      </div>

      <div class="alarm-row" data-hour="14">
        <div class="alarm-left">
          <div>
            <span class="alarm-time">2:00</span>
            <span class="alarm-am">PM</span>
          </div>
          <div class="alarm-label">Standup</div>
        </div>
        <div class="switch"><div class="switch-knob"></div></div>
      </div>

      <div class="alarm-row" data-hour="15">
        <div class="alarm-left">
          <div>
            <span class="alarm-time">3:00</span>
            <span class="alarm-am">PM</span>
          </div>
          <div class="alarm-label">Afternoon Meeting</div>
        </div>
        <div class="switch"><div class="switch-knob"></div></div>
      </div>

      <div class="alarm-row" data-hour="16">
        <div class="alarm-left">
          <div>
            <span class="alarm-time">4:00</span>
            <span class="alarm-am">PM</span>
          </div>
          <div class="alarm-label">Pick up kids</div>
        </div>
        <div class="switch"><div class="switch-knob"></div></div>
      </div>

      <div class="alarm-row" data-hour="17">
        <div class="alarm-left">
          <div>
            <span class="alarm-time">5:00</span>
            <span class="alarm-am">PM</span>
          </div>
          <div class="alarm-label">End Work</div>
        </div>
        <div class="switch"><div class="switch-knob"></div></div>
      </div>

      <div class="alarm-row" data-hour="18">
        <div class="alarm-left">
          <div>
            <span class="alarm-time">6:00</span>
            <span class="alarm-am">PM</span>
          </div>
          <div class="alarm-label">Gym Time</div>
        </div>
        <div class="switch"><div class="switch-knob"></div></div>
      </div>

      <div class="alarm-row" data-hour="18">
        <div class="alarm-left">
          <div>
            <span class="alarm-time">6:30</span>
            <span class="alarm-am">PM</span>
          </div>
          <div class="alarm-label">Dinner Prep</div>
        </div>
        <div class="switch"><div class="switch-knob"></div></div>
      </div>

      <div class="alarm-row" data-hour="19">
        <div class="alarm-left">
          <div>
            <span class="alarm-time">7:00</span>
            <span class="alarm-am">PM</span>
          </div>
          <div class="alarm-label">Dinner</div>
        </div>
        <div class="switch"><div class="switch-knob"></div></div>
      </div>

      <div class="alarm-row" data-hour="20">
        <div class="alarm-left">
          <div>
            <span class="alarm-time">8:00</span>
            <span class="alarm-am">PM</span>
          </div>
          <div class="alarm-label">Family Time</div>
        </div>
        <div class="switch"><div class="switch-knob"></div></div>
      </div>

      <div class="alarm-row" data-hour="21">
        <div class="alarm-left">
          <div>
            <span class="alarm-time">9:00</span>
            <span class="alarm-am">PM</span>
          </div>
          <div class="alarm-label">Wind Down</div>
        </div>
        <div class="switch"><div class="switch-knob"></div></div>
      </div>

      <div class="alarm-row" data-hour="21">
        <div class="alarm-left">
          <div>
            <span class="alarm-time">9:30</span>
            <span class="alarm-am">PM</span>
          </div>
          <div class="alarm-label">Reading</div>
        </div>
        <div class="switch"><div class="switch-knob"></div></div>
      </div>

      <div class="alarm-row" data-hour="22">
        <div class="alarm-left">
          <div>
            <span class="alarm-time">10:00</span>
            <span class="alarm-am">PM</span>
          </div>
          <div class="alarm-label">Bedtime Prep</div>
        </div>
        <div class="switch"><div class="switch-knob"></div></div>
      </div>

      <div class="alarm-row" data-hour="22">
        <div class="alarm-left">
          <div>
            <span class="alarm-time">10:30</span>
            <span class="alarm-am">PM</span>
          </div>
          <div class="alarm-label">Bedtime</div>
        </div>
        <div class="switch"><div class="switch-knob"></div></div>
      </div>

      <div class="alarm-row" data-hour="23">
        <div class="alarm-left">
          <div>
            <span class="alarm-time">11:00</span>
            <span class="alarm-am">PM</span>
          </div>
          <div class="alarm-label">Late Night</div>
        </div>
        <div class="switch"><div class="switch-knob"></div></div>
      </div>
    </div>

    <div class="dial-container">
      <div class="dial" id="dial">
        <div class="dial-am-label">
          <svg class="label-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="5"></circle>
            <line x1="12" y1="1" x2="12" y2="3"></line>
            <line x1="12" y1="21" x2="12" y2="23"></line>
            <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
            <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
            <line x1="1" y1="12" x2="3" y2="12"></line>
            <line x1="21" y1="12" x2="23" y2="12"></line>
            <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
            <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
          </svg>
          AM
        </div>
        <div class="dial-pm-label">
          <svg class="label-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
          </svg>
          PM
        </div>
      </div>
      <div class="dial-pointer"></div>
    </div>

    <div id="trial-modal" class="trial-modal hidden">
      <div class="trial-modal-content">
        <h2 id="modal-title">Target alarm</h2>
        <p id="modal-body">Turn off the target alarm.</p>
        <ul class="modal-steps">
          <li>Note the target alarm time below.</li>
          <li>Use the shown technique to find and turn it off.</li>
          <li>Only turn off that alarm; others count as errors.</li>
        </ul>
        <button id="modal-start" class="pill-btn">Begin trial</button>
      </div>
    </div>

    <div id="effort-modal" class="trial-modal hidden">
      <div class="trial-modal-content">
        <h2>Mental effort</h2>
        <p>How mentally demanding was this task? (0 = very low, 100 = very high)</p>
        <input id="effort-slider" type="range" min="0" max="100" value="50" />
        <div class="slider-labels">
          <span>0</span><span>25</span><span>50</span><span>75</span><span>100</span>
        </div>
        <button id="effort-submit" class="pill-btn">Submit rating</button>
      </div>
    </div>
  </div>

  <script src="script.js"></script>
  <script>
  (() => {
    // Google Sheet Web App endpoint for saving results
    const SHEET_WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbwYw0VQ6o14x13y8nxoD_Pjf9ue4-Ptx6ZBvKX-9ccDMTgcMkkqcW2F5gPJ9jAcn_WG/exec';

    const storedTrials = JSON.parse(sessionStorage.getItem('experimentTrials') || '[]');
    const participantId = sessionStorage.getItem('participantId') || 'P000';
    const storedResults = JSON.parse(sessionStorage.getItem('experimentResults') || '[]');
    const storedResultsPersistent = JSON.parse(localStorage.getItem('experimentResults') || '[]');
    const fallbackTrials = [
      { tech: 'Radial Clock-Wheel', len: 10, pos: 'Top', rep: 1 },
      { tech: 'Scroll', len: 10, pos: 'Bottom', rep: 1 }
    ];

    const state = {
      trials: storedTrials.length ? storedTrials : fallbackTrials,
      idx: 0,
      participant: participantId,
      currentTarget: null,
      results: storedResults.length ? storedResults : storedResultsPersistent,
      currentErrors: 0,
      trialActive: false,
      trialStart: 0,
      pendingResult: null
    };

    const alarmsScroll = document.getElementById('alarmsScroll');
    const dialContainer = document.querySelector('.dial-container');
    const trialMeta = document.getElementById('trial-meta');
    const trialTech = document.getElementById('trial-tech');
    const nextBtn = document.getElementById('next-trial');
    const modal = document.getElementById('trial-modal');
    const modalTitle = document.getElementById('modal-title');
    const modalBody = document.getElementById('modal-body');
    const modalStart = document.getElementById('modal-start');
    const effortModal = document.getElementById('effort-modal');
    const effortSlider = document.getElementById('effort-slider');
    const effortSubmit = document.getElementById('effort-submit');

    function buildAlarmPool(count = 30) {
      const pool = [];
      let minutes = 300; // start at 5:00 AM
      for (let i = 0; i < count; i++) {
        const hour = Math.floor(minutes / 60) % 24;
        const minute = minutes % 60;
        pool.push({ hour, minute, label: `Alarm ${String(i + 1).padStart(2, '0')}` });
        minutes += 35; // spaced so lists have varied AM/PM coverage
      }
      return pool;
    }

    const alarmPool = buildAlarmPool(30);

    function formatTimeParts(alarm) {
      const h12 = ((alarm.hour + 11) % 12) + 1;
      const ampm = alarm.hour < 12 ? 'AM' : 'PM';
      const mm = alarm.minute.toString().padStart(2, '0');
      return { time: `${h12}:${mm}`, suffix: ampm };
    }

    function targetIndexForPosition(pos, len) {
      if (pos === 'Top') return 0;
      if (pos === 'Bottom') return Math.max(len - 1, 0);
      return Math.floor(len / 2);
    }

    function renderTrial() {
      const trial = state.trials[state.idx];
      const alarms = alarmPool.slice(0, trial.len);
      const targetIndex = targetIndexForPosition(trial.pos, alarms.length);
      state.currentTarget = alarms[targetIndex];
      state.currentErrors = 0;
      state.trialActive = false;
      state.pendingResult = null;

      trialMeta.textContent = `Trial ${state.idx + 1} of ${state.trials.length}`;
      trialTech.textContent = `${trial.tech} · ${trial.len} alarms · Target: ${trial.pos}`;

      alarmsScroll.innerHTML = '';
      alarms.forEach((alarm, idx) => {
        const { time, suffix } = formatTimeParts(alarm);
        const row = document.createElement('div');
        row.className = 'alarm-row' + (idx === targetIndex ? ' target-row' : '');
        row.dataset.hour = alarm.hour;
        row.innerHTML = `
          <div class="alarm-left">
            <div>
              <span class="alarm-time">${time}</span>
              <span class="alarm-am">${suffix}</span>
            </div>
            <div class="alarm-label">${idx === targetIndex ? 'Target alarm — turn off' : alarm.label}</div>
          </div>
          <div class="switch${idx === targetIndex ? '' : ' off'}"><div class="switch-knob"></div></div>
        `;
        alarmsScroll.appendChild(row);
      });

      const useDial = trial.tech === 'Radial Clock-Wheel';
      dialContainer.style.display = useDial ? 'block' : 'none';
      if (window.alarmDial) {
        window.alarmDial.setActive(useDial);
        window.alarmDial.refresh();
      }

      showModal(trial, formatTimeParts(state.currentTarget));
      updateNextButtonLabel();
      nextBtn.disabled = true; // disabled until effort rating is captured
    }

    function showModal(trial, targetParts) {
      modalTitle.textContent = `Target alarm: ${targetParts.time} ${targetParts.suffix}`;
      modalBody.textContent = `Technique: ${trial.tech}. Position: ${trial.pos}. Turn off this alarm when the trial starts.`;
      modal.classList.remove('hidden');
    }

    function showEffortModal() {
      effortSlider.value = 50;
      effortModal.classList.remove('hidden');
    }

    function updateNextButtonLabel() {
      const last = state.idx === state.trials.length - 1;
      nextBtn.textContent = last ? 'Finish trials' : 'Next trial';
    }

    modalStart.onclick = () => {
      modal.classList.add('hidden');
      state.trialActive = true;
      state.trialStart = performance.now();
    };

    effortSubmit.onclick = () => {
      if (!state.pendingResult) return;
      state.pendingResult.mental_effort = parseInt(effortSlider.value, 10);
      state.results.push(state.pendingResult);
      const serialized = JSON.stringify(state.results);
      sessionStorage.setItem('experimentResults', serialized);
      localStorage.setItem('experimentResults', serialized);
      effortModal.classList.add('hidden');
      nextBtn.disabled = false;
      updateNextButtonLabel();
    };

    nextBtn.onclick = () => {
      if (state.idx < state.trials.length - 1) {
        state.idx += 1;
        renderTrial();
      } else {
        nextBtn.disabled = true;
        nextBtn.textContent = 'All trials completed';
        alert('All trials completed. Return to the setup page to configure a new order.');
      }
    };

    function toCsv(rows) {
      const headers = ['Participant_ID','Trial','Technique','List_Length','Target_Position','Rep','Completion_Time_ms','Errors','Mental_Effort','Target_Time'];
      const body = rows.map(r => [r.participant,r.trial,r.technique,r.list_length,r.target_position,r.rep,r.completion_time_ms,r.errors,r.mental_effort ?? '',r.target_time]);
      return [headers, ...body].map(r => r.join(',')).join('\n');
    }

    function downloadFile(name, mime, content) {
      const blob = new Blob([content], { type: mime });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = name;
      a.click();
      URL.revokeObjectURL(url);
    }

    // Quick exports during testing
    document.addEventListener('keydown', (e) => {
      if (e.key === 'E' && e.altKey) {
        downloadFile('alarm_trials_results.csv', 'text/csv', toCsv(state.results));
      }
      if (e.key === 'J' && e.altKey) {
        downloadFile('alarm_trials_results.json', 'application/json', JSON.stringify(state.results, null, 2));
      }
    });

    alarmsScroll.addEventListener('click', (e) => {
      const switchEl = e.target.closest('.switch');
      if (!switchEl) return;
      e.stopImmediatePropagation();
      const row = switchEl.closest('.alarm-row');
      const isTarget = row && row.classList.contains('target-row');

      // Toggle visual state manually
      const willTurnOff = !switchEl.classList.contains('off');
      if (willTurnOff) {
        switchEl.classList.add('off');
      } else {
        switchEl.classList.remove('off');
      }

      if (!state.trialActive) return;

      if (isTarget && willTurnOff) {
        // Only count completion the first time target is turned off
        state.trialActive = false;
        const elapsedMs = Math.round(performance.now() - state.trialStart);
        const trial = state.trials[state.idx];
        const { time, suffix } = formatTimeParts(state.currentTarget);
        state.pendingResult = {
          participant: state.participant,
          trial: state.idx + 1,
          technique: trial.tech,
          list_length: trial.len,
          target_position: trial.pos,
          rep: trial.rep,
          completion_time_ms: elapsedMs,
          errors: state.currentErrors,
          mental_effort: null,
          target_time: `${time} ${suffix}`
        };
        showEffortModal();
      } else if (!isTarget && willTurnOff) {
        // Count as an error when the participant turns off a non-target alarm
        state.currentErrors += 1;
      }
    });

    renderTrial();
  })();
  </script>
</body>
</html>
