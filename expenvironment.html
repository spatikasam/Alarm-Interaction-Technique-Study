<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>Scroll vs Quick Panel – Alarm Study</title>
<style>
  :root { --blue:#007aff; --red:#ff3b30; --green:#34c759; }
  * { box-sizing:border-box; margin:0; padding:0; }
  body {
    font-family:-apple-system,system-ui,sans-serif;
    background:#f2f2f7; color:#1d1d1f;
    min-height:100dvh; padding:20px;
    line-height:1.5;
  }
  .container { max-width:1000px; margin:0 auto; }

  h1 { text-align:center; font-size:32px; font-weight:800; margin:20px 0 10px; }
  .config, #trial-table-container, #results-container {
    background:white; border-radius:20px; padding:24px; margin:20px 0;
    box-shadow:0 10px 30px rgba(0,0,0,0.1);
  }
  button {
    background:var(--blue); color:white; border:none; border-radius:14px;
    padding:16px 32px; font-size:20px; font-weight:700; cursor:pointer;
  }
  button:disabled { background:#aaa; cursor:not-allowed; }

  /* ==================== ONLY THE TRIAL PART IS INSIDE IPHONE ==================== */
  .iphone-frame {
    width:420px; height:900px; background:#111; border-radius:64px;
    padding:20px; margin:40px auto; box-shadow:0 20px 60px rgba(0,0,0,0.4);
    display:none; /* hidden until experiment starts */
  }
  .iphone {
    width:100%; height:100%; background:#000; border-radius:50px; overflow:hidden;
    position:relative; box-shadow:0 0 0 12px #222;
  }
  .notch {
    position:absolute; top:8px; left:50%; transform:translateX(-50%);
    width:210px; height:34px; background:#000; border-radius:20px; z-index:10;
  }
  .screen {
    width:100%; height:100%; background:#f5f5f7; border-radius:44px; overflow:hidden;
    display:flex; flex-direction:column;
  }

  /* iOS Status Bar */
  .status-bar {
    height:48px; background:#000000e6; backdrop-filter:blur(10px);
    display:flex; align-items:center; justify-content:space-between; padding:0 24px;
    font-size:16px; font-weight:600; color:white; z-index:9;
  }
  .time { font-weight:700; font-size:18px; }
  .battery { width:28px; height:13px; border:2.5px solid white; border-radius:4px; position:relative; }
  .battery::after { content:''; position:absolute; right:-5px; top:3px; width:5px; height:7px; background:white; }

  /* Alarm Header */
  .header {
    height:100px; background:#f2f2f7; display:flex; align-items:center; justify-content:center;
    font-size:36px; font-weight:800; color:#000; position:relative;
  }
  .header::before { content:"9:41"; position:absolute; left:24px; top:14px; font-size:16px; color:#000; font-weight:600; }
  .header .bell { position:absolute; right:24px; top:16px; font-size:26px; color:var(--red); animation:ring 2s infinite; }
  @keyframes ring { 0%,100% { transform:rotate(0); } 10%,30%,50%,70%,90% { transform:rotate(-15deg); } 20%,40%,60%,80% { transform:rotate(15deg); } }

  /* Alarm List */
  .alarm-list {
    flex:1; overflow-y:auto; padding:12px 0 120px;
    -webkit-overflow-scrolling:touch;
  }
  .alarm-item {
    margin:0 18px 12px; background:white; border-radius:18px;
    padding:20px 22px; display:flex; justify-content:space-between; align-items:center;
    box-shadow:0 2px 8px rgba(0,0,0,0.1);
    transition:background 0.3s;
  }
  .time-label { font-size:36px; font-weight:600; color:#000; }
  .ampm { font-size:15px; color:#888; margin-top:4px; }

  /* iOS Switch */
  .switch { position:relative; display:inline-block; width:51px; height:31px; }
  .switch input { opacity:0; width:0; height:0; }
  .slider { position:absolute; inset:0; background:#c7c7cc; border-radius:34px; transition:.3s; }
  .slider:before { content:""; position:absolute; width:27px; height:27px; left:2px; bottom:2px;
                   background:white; border-radius:50%; transition:.3s; box-shadow; }
  input:checked + .slider { background:var(--green); }
  input:checked + .slider:before { transform:translateX(20px); }

  /* Quick Panel */
  .quick-panel {
    position:fixed; top:0; left:-300px; width:300px; height:100dvh;
    background:rgba(255,255,255,0.95); backdrop-filter:blur(30px);
    border-right:6px solid var(--blue); box-shadow:20px 0 60px rgba(0,0,0,0.3);
    padding:120px 24px 40px; transition:left .45s ease;
    z-index:1000; display:flex; flex-direction:column; gap:16px;
  }
  .quick-panel.open { left:0; }
  .panel-title {
    position:fixed; top:48px; left:0; width:300px; background:rgba(255,255,255,0.98);
    padding:20px; text-align:center; font-weight:800; font-size:22px; color:var(--blue);
    border-bottom:3px solid #d0d0d7; z-index:1001;
  }
  .hour-btn {
    padding:24px; background:#f0f0f7; border:none; border-radius:20px;
    font-size:24px; font-weight:700; color:#000;
  }

  .tap-zone { position:fixed; left:0; top:0; width:140px; height:100dvh; z-index:999; }

  /* Mental effort sheet */
  .mental-sheet {
    position:fixed; bottom:-400px; left:50%; transform:translateX(-50%);
    width:390px; background:white; border-radius:32px 32px 0 0;
    padding:30px 20px 40px; box-shadow:0 -10px 40px rgba(0,0,0,0.3);
    transition:bottom .5s ease; z-index:1002; text-align:center;
  }
  .mental-sheet.visible { bottom:0; }

  table { width:100%; border-collapse:collapse; margin-top:10px; }
  th, td { padding:12px; text-align:left; border-bottom:1px solid #ddd; }
  th { background:#f0f0f7; font-weight:700; }
</style>
</head>
<body>

<div class="container">
  <h1>Scroll vs Quick Panel<br><small style="font-weight:400;font-size:18px;">Alarm Deactivation Study</small></h1>

  <div class="config">
    <div style="display:flex;gap:16px;flex-wrap:wrap;margin-bottom:20px;">
      <div style="flex:1;min-width:220px;"><label>Participant ID</label><input id="pid" value="P001" style="width:100%;padding:12px;font-size:16px;border:2px solid #ddd;border-radius:10px;margin-top:8px;"></div>
      <div style="flex:1;min-width:140px;"><label>Trials per condition</label><input id="reps" type="number" value="5" min="1" style="width:100%;padding:12px;font-size:16px;border:2px solid #ddd;border-radius:10px;margin-top:8px;"></div>
      <div style="flex:1;min-width:180px;"><label>Seed (optional)</label><input id="seed" placeholder="leave empty = random" style="width:100%;padding:12px;font-size:16px;border:2px solid #ddd;border-radius:10px;margin-top:8px;"></div>
    </div>
    <button id="gen" style="width:100%;padding:18px;">Generate Trial Order</button>
  </div>

  <div id="trial-table-container" style="display:none;">
    <h2 style="margin-bottom:12px;">Trial Order (Quick Panel block first)</h2>
    <table id="trial-table">
      <thead><tr><th>#</th><th>Technique</th><th>Length</th><th>Position</th><th>Rep</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <div style="text-align:center;margin:50px 0;">
    <button id="start" disabled style="padding:22px 80px;font-size:24px;">Start Experiment</button>
  </div>

  <div id="results-container" style="display:none;">
    <h2>Experiment Complete – Results</h2>
    <table id="results-table">
      <thead><tr><th>PID</th><th>Trial</th><th>Tech</th><th>Len</th><th>Pos</th><th>Rep</th><th>Time(ms)</th><th>Errors</th><th>Mental</th><th>Target</th></tr></thead>
      <tbody></tbody>
    </table>
    <div style="text-align:center;margin-top:30px;">
      <button id="download-csv" style="padding:18px 50px;font-size:21px;">Download CSV</button>
    </div>
  </div>
</div>

<script>
const state = { trials: [], idx: 0, results: [], participantId: '' };
const mulberry32 = s => { let a=s>>>0; return()=>(a+=0x6D2B79F5,a^=a>>>15,a=Math.imul(a,a|1),a^=a+Math.imul(a^a>>>7,a|61),((a^a>>>14)>>>0)/4294967296); };

// Generate trials
document.getElementById('gen').onclick = () => {
  const reps = parseInt(document.getElementById('reps').value)||1;
  const seed = document.getElementById('seed').value.trim()==='' ? Math.random()*4294967295 : +document.getElementById('seed').value;
  const rng = mulberry32(seed);

  const conditions = [];
  ['Quick Panel','Scroll'].forEach(tech=>[10,20,30].forEach(len=>['Top','Middle','Bottom'].forEach(pos=>conditions.push({tech,len,pos}))));

  const all = [];
  conditions.forEach(c=>{for(let i=1;i<=reps;i++)all.push({...c,rep:i});});

  const blocks = {'Quick Panel':[],'Scroll':[]};
  all.forEach(t=>blocks[t.tech].push(t));

  const ordered = [];
  ['Quick Panel','Scroll'].forEach(tech=>{
    const b = blocks[tech];
    for(let i=b.length-1;i>0;i--){
      const j=Math.floor(rng()*(i+1));
      [b[i],b[j]]=[b[j],b[i]];
    }
    ordered.push(...b);
  });

  state.trials = ordered; 
  state.idx=0; 
  state.results=[];
  state.participantId = document.getElementById('pid').value;
  
  const tbody = document.querySelector('#trial-table tbody');
  tbody.innerHTML=''; 
  state.trials.forEach((t,i)=>{ 
    const tr=document.createElement('tr'); 
    tr.innerHTML=`<td>${i+1}</td><td>${t.tech}</td><td>${t.len}</td><td>${t.pos}</td><td>${t.rep}</td>`; 
    tbody.appendChild(tr); 
  });

  document.getElementById('trial-table-container').style.display='block';
  document.getElementById('start').disabled=false;
  alert(`Generated ${state.trials.length} trials – Quick Panel first`);
};

// Start → redirect to index.html with trial data
document.getElementById('start').onclick = () => {
  // Store trial configuration in sessionStorage
  sessionStorage.setItem('experimentTrials', JSON.stringify(state.trials));
  sessionStorage.setItem('participantId', state.participantId);
  
  // Redirect to index.html
  window.location.href = 'index.html';
};

// Results display
function showResults(){
  const tbody = document.querySelector('#results-table tbody');
  tbody.innerHTML = '';
  
  state.results.forEach(r => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${r.participant}</td>
      <td>${r.trial}</td>
      <td>${r.technique}</td>
      <td>${r.list_length}</td>
      <td>${r.target_position}</td>
      <td>${r.rep}</td>
      <td>${r.completion_time_ms}</td>
      <td>${r.errors}</td>
      <td>${r.mental_effort}</td>
      <td>${r.target_time}</td>
    `;
    tbody.appendChild(tr);
  });
}

// CSV Download
document.getElementById('download-csv').onclick = () => {
  const headers = ['Participant_ID','Trial','Technique','List_Length','Target_Position','Rep','Completion_Time_ms','Errors','Mental_Effort','Target_Time'];
  const rows = state.results.map(r => [
    r.participant, r.trial, r.technique, r.list_length, r.target_position, r.rep,
    r.completion_time_ms, r.errors, r.mental_effort, r.target_time
  ]);
  
  const csv = [headers, ...rows].map(row => row.join(',')).join('\n');
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `alarm_study_${state.participantId}_${new Date().toISOString().slice(0,10)}.csv`;
  a.click();
  URL.revokeObjectURL(url);
};
</script>
</body>
</html>
